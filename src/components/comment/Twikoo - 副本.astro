---
const config = {
	el: "#comment",
	path: Astro.props.path,
};
---
<div id="comment">
  <div class="text-center text-gray-500 dark:text-gray-400 p-8">
    <p>评论区加载中...</p>
    <p class="text-sm mt-2">如果长时间无法显示，请尝试刷新页面。</p>
  </div>
</div>
<script is:inline define:vars={{ config }}>
  function initTwikoo() {
    console.log('开始初始化 Twikoo 评论系统');
    const commentContainer = document.getElementById('comment');
    if (!commentContainer) {
      console.error('评论容器不存在');
      return;
    }
    console.log('评论容器已找到');

    // 直接初始化 Twikoo（如果已加载）
    if (window.twikoo) {
      console.log('Twikoo 已加载，直接初始化');
      window.twikoo.init({
        ...config,
        envId: "https://twikoo.liyueovo.top",
        lang: 'zh-CN',
      });
      return;
    }

    // 检查脚本是否已存在
    let script = document.getElementById('twikoo-script');
    if (!script) {
      console.log('创建新的 Twikoo 脚本标签');
      // 创建并注入新的 Twikoo 脚本
      script = document.createElement('script');
      script.id = 'twikoo-script';
      script.src = '/twikoo/twikoo.min.js';
      script.defer = true;

      // 脚本加载后初始化 Twikoo
      script.onload = () => {
        console.log('Twikoo 脚本加载完成');
        if (window.twikoo) {
          console.log('Twikoo 初始化开始');
          window.twikoo.init({
            ...config,
            envId: "https://twikoo.liyueovo.top",
            lang: 'zh-CN',
          });
          console.log('Twikoo 初始化完成');
        } else {
          console.error('Twikoo 加载失败，window.twikoo 未定义');
        }
      };

      script.onerror = () => {
        console.error('Twikoo 脚本加载失败');
      };

      document.head.appendChild(script);
      console.log('Twikoo 脚本标签已添加到页面');
    } else {
      console.log('Twikoo 脚本标签已存在');
    }
  }

  // 使用多种方式确保初始化
  console.log('设置 Twikoo 初始化');
  
  // 1. 立即尝试初始化（如果页面已加载）
  if (document.readyState === 'loading') {
    console.log('页面正在加载，监听 DOMContentLoaded 事件');
    document.addEventListener('DOMContentLoaded', initTwikoo);
  } else if (document.readyState === 'interactive' || document.readyState === 'complete') {
    console.log('页面已加载，立即初始化 Twikoo');
    initTwikoo();
  }

  // 2. 监听 Astro 的页面加载事件
  console.log('监听 astro:page-load 事件');
  document.addEventListener('astro:page-load', initTwikoo);
</script>